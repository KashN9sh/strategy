### Чеклист реализации (изометрическая стратегия в стиле Anno)

- **Базовый движок (MVP)**
  - [x] Тики симуляции (фикс. шаг 30–60 Гц), пауза/скорости (0.5x/1x/2x/3x)
  - [x] Горячие клавиши и ребиндинг, конфиг (TOML)
  - [x] Сохранение/загрузка (JSON) с версионированием

- **Рендер и графика**
  - [x] Атлас тайлов и спрайтов зданий, блит с альфой
  - [x] Анимации воды (кадровая)
  - [x] Оверлеи: сетка, подсветка клетки/плотности леса
  - [x] Z-сортировка зданий
  - [x] Отрисовка деревьев на лесных тайлах (отдельные сущности)
  - [x] Деревья из отдельного атласа (спрайты) с фоллбеком при отсутствии файла
  - [ ] Дороги/угловые соединения

- **Мир и чанки**
  - [x] Генерация чанков в фоне, прогрев кольца
  - [x] Лимит памяти по чанкам (грубая очистка при превышении max)
  - [ ] Выгрузка дальних чанков (LRU по расстоянию от камеры)
  - [~] Биомы: базовая шумовая карта, береговая линия
  - [x] Стабильный сид мира в сохранениях
  - [x] Деревья как сущности: первичное заполнение по лесным тайлам
  - [x] Сохранение/загрузка деревьев (позиция, стадия, возраст)
  - [ ] Экспансия: новые регионы/острова (доки/переходы)
  - [ ] Точки интереса: тайники/караваны/бандиты (малые риски/награды)
  - [ ] Редкие ресурсы и исчерпаемость месторождений
  - [ ] (Опционально) Туман войны/разведка

- **Ввод/камеры**
  - [x] Зум со «снэпом» к пикселям (без швов), панорамирование
  - [ ] Плавность/инерция, перетаскивание правой/средней, ограничители

- **Строительство**
  - [x] Размещение, валидаторы (вода/занято)
  - [ ] План-режим (призраки), снос/перенос, возврат
  - **Дороги**
    - [x] Режим дорог, постановка/снятие по ЛКМ
    - [ ] Автосоединение спрайтов по соседям (N/E/S/W маска)
    - [ ] Учёт дорог в стоимости тайла (вес < грунта)
    - [ ] A* + визуализация пути
    - [ ] Носильщики/повозки: перемещение по путям
    - [ ] Инструменты редактирования: протяжка drag, удаление, пипетка
    - [ ] Сохранение/загрузка дорог

- **Логистика и ресурсы**
  - [x] Базовые цепочки (лесоруб → дерево; дом потребляет/налог)
  - [x] Склады: базовая постройка и суммарный запас в UI
  - [x] ChopWood удаляет дерево, спавнит полено; HaulWood доставляет на склад/дом
  - [x] Новые ресурсы (MVP):
    - [x] Камень (Карьер)
    - [x] Глина → Кирпич (Глиняный карьер → Обжиг)
    - [x] Пшеница → Мука → Хлеб (Поле → Мельница → Пекарня)
    - [x] Рыба (Рыбацкий причал, у воды)
  - [ ] Металлы (этап 2): Железо→Инструменты, Уголь/Древесный уголь
  - [ ] «Удобства» (этап 2): Шерсть→Ткань→Одежда или Хмель→Пиво
  - [ ] Склады/ёмкость, резервирование, отчёты «чего не хватает»
  - [ ] Транспорт: носильщики/повозки, маршруты по дорогам
  - [ ] Баланс: вход/выход в минуту, потребление жителями

- **Экономика и торговля**
  - [ ] Торговый пост (NPC) на краю карты, динамические цены
  - [ ] Контракты/квоты на поставку, базовая дипломатия (нейтрально)
  - [ ] Торговые караваны (спавнятся по расписанию)

- **Население и потребности (Anno-подобное)**
  - [ ] Дома уровней (уровень 1..N), апгрейды при удовлетворении нужд
  - [ ] Потребности: базовые/роскошь, счастье/налоги
  - [ ] Рынки/церкви/развлечения: радиусы влияния, покрытие
  - [ ] Панель дома: статус, чего не хватает, прогресс апгрейда

- **AI и путь**
  - [ ] Поиск пути (A*) на изометрической сетке с весами дорог
  - [x] Базовая очередь задач и назначение ближайшему жителю
  - [ ] Приоритеты, таймауты/возврат задач, очереди заявок
  - [ ] Лесник: планирование посадок деревьев, очередь посадки
  - [ ] Избежание коллизий/пробок (simple reservation)

- **UI/UX**
  - [x] Верхняя панель ресурсов (масштабируемая), FPS, пауза/скорость
  - [x] Меню строительства (кнопки + хоткеи, кликабельные)
  - [x] Индикатор запасов складов (суммарно)
  - [x] Счётчики новых ресурсов на панели (камень, глина, кирпич, пшеница, мука, хлеб, рыба)
  - [ ] Tooltip’ы, инфо-панель здания, окно статистики
  - [ ] Мини-задачи/чеклист целей (справа), прогресс-бар
  - [ ] Визуализация логистики: линии доставки на наведении, тепловая карта трафика
  - [ ] Панель «узкие места»: недоставки/переполнения складов
  - [ ] Достижения/вехи (показывать при выполнении)

- **Аудио**
  - [ ] Фоновая музыка, звуки размещения/производства
  - [ ] Громкость/мьют в настройках

- **Производительность**
  - [ ] Профилирование (FPS-граф, время шагов), метрики
  - [ ] Кэш проекций экран→тайл на фрейм, отсечение вне экрана
  - [ ] Инкрементальные обновления слоёв/оверлеев
  - [ ] Метрики вовлечения (для себя): time-to-first-upgrade, time-to-first-trade
  - [x] Кэш месторождений (шум → кэш) для быстрых оверлеев
  - [x] Быстрый альфа‑блит без рескейла для оверлеев месторождений
  - [x] Сортировка зданий только при изменениях (dirty-flag)
  - [x] Сокращённый запас видимых тайлов вокруг экрана

- **Ивенты/сезоны**
  - [ ] Сезоны (влияние на урожай/скорости дорог)
  - [ ] Лёгкие ивенты: «урожайный год», «дождь», «сбои поставок»

- **Инструменты/моды**
  - [ ] Датадривен-дефы зданий/ресурсов (TOML/YAML)
  - [ ] Редактор карты/биомов, сид-менеджер
  - [ ] Скриншоты/экспорт реплея (seed + действия)

- **Сборки и платформа**
  - [ ] Mac/Win/Linux таргеты, иконка/версия
  - [ ] Настройки окна/VSYNC/Fullscreen, проверка на разных DPI
  - [x] Оптимизированные профили: release (LTO, codegen-units=1, panic=abort), dev (ускорённые opt-level)

### Приоритеты

- MVP: рендер/камера без артефактов, чанки с фоновой генерацией, строительство/снос, базовые цепочки, склады, панель ресурсов, сохранение/загрузка.
- Next: дороги+логистика, оверлеи, A*, потребности домов и налоги.
- Later: анимации, аудио, моддинг, редактор, продвинутые биомы.

### Вовлекающие «петли» (для дизайна)

- Короткая (1–3 мин): быстрый эффект от постройки, отчёт «+X/мин», всплывающие +1
- Средняя (10–30 мин): расширение/оптимизация логистики, склады-«узлы», снятие пробок
- Длинная (1–3 ч): освоение новых биомов/торговля/редкие ресурсы, сценарные цели

### Системы, которые дают «вкусные» решения

- Потребности и уровни домов
  - [ ] Уровни T1→T2→T3 с требованиями (еда/вода/одежда/роскошь)
  - [ ] Счастье/налоги: баланс дохода и роста населения
- Логистика как головоломка
  - [ ] Носильщики/повозки, веса дорог, пробки и обходы
  - [ ] Склады-буферы, резервирование, «узкие места» и отчёты
- Производственные компромиссы
  - [ ] Ветки апгрейдов: скорость vs. ресурс/энергия/рабочие
  - [ ] Исчерпаемость/редкость сырья, альтернативные рецепты
- Карта и экспансия
  - [ ] Биомы/острова с разной «плодородностью», редкие точки интереса
  - [ ] Риски/награды: тайники, караваны, бандиты (малые ивенты)
- Торговля и цены
  - [ ] Динамические цены, контракты/квоты, окна поставок
  - [ ] Логистика торговли: доки, караваны, складские хабы
- Сезоны и ивенты
  - [ ] Влияние на урожай/скорость дорог/пожары/штормы
  - [ ] Предупреждения и подготовка (колодцы, запасы, диверсификация)
- Миссии и цели
  - [ ] Короткие квесты в UI (накопи X, покрой Y%), награды/разблокировки
  - [ ] Достижения и долгосрочные сценарные задачи

### Итерационный план (3 спринта)

- Итерация 1 (Дороги и логистика)
  - [x] Режим дорог, постановка/снятие (базовый)
  - [ ] Автосоединение спрайтов (4-соседа)
  - [ ] A* с весами (дорога/грунт), простые носильщики
  - [ ] Склады: ёмкость, резервирование, панель «узкие места»

- Итерация 2 (Жители и потребности)
  - [ ] Дома T1→T2 при покрытии базовых нужд
  - [ ] Рынок/колодец с радиусом покрытия; налоги/счастье
  - [ ] Инфо-панель дома + tooltip’ы UI

- Итерация 3 (Торговля и ивенты)
  - [ ] Торговый пост NPC, динамические цены, контракты
  - [ ] 1–2 ивента/сезона, влияющих на планирование
  - [ ] Мини-задачи/чеклист целей в UI

### Технический долг / Рефакторинг (статус)

- Структура проекта
  - [x] Вынести `world` (генератор чанков, tx/rx/pending) в `src/world.rs`
  - [x] Вынести атласы и рендер: `src/atlas.rs`, `src/render/tiles.rs`
  - [x] Вынести UI и ввод: `src/ui.rs`, `src/input.rs`; параметр `ui_scale_base` в `config.toml`
  - [x] Вынести путь: `src/path.rs`
  - [x] Вынести задачи: `src/jobs.rs`
  - [ ] Дальнейшая декомпозиция: `roads.rs`, `save.rs`, `config.rs`
  - [ ] Выделить слой «логика vs рендер» (DTO для отрисовки)

- Уборка и единообразие
  - [x] Удалить дубли рендера из `main.rs` (вынесено в `render/tiles.rs`)
  - [ ] Вынести альфа-блит и ресэмпл в общий модуль (nearest), без копипасты
  - [ ] Починить предупреждения компилятора (unused `show_ui`, избыточный `mut` и т.п.)

- Конфиг/ввод/сейвы
  - [x] `config.toml`: добавлен `ui_scale_base`, хоткеи уже вынесены; загрузка по умолчанию
  - [ ] `serde(default)` для всех полей и версионирование конфига
  - [ ] `SaveData`: версионирование, добавление дорог/мировых параметров
  - [x] Единый маппинг клавиш (строки → KeyCode) в модуле `input`

- Качество и тесты
  - [ ] Юнит‑тесты: обратимость `screen_to_tile_px`/`tile_to_screen`, маска дорог, стоимость тайла, A*
  - [ ] `clippy`/`rustfmt`, базовый `tracing` для профилирования

- Производительность
  - [ ] Предкэш масок/геометрии ромба под зум, батчинг блитов тайлов/дорог
  - [ ] LRU выгрузка чанков по расстоянию от камеры

### Ближайшие шаги после рефакторинга

- [ ] Roads: автосоединение по соседям (битовая маска 4‑направлений), временный визуал
- [ ] Path: A* с весами (дорога < грунта), простая визуализация пути
- [ ] Save/Load: сохранить дороги и параметры мира; версия сейва
- [ ] Warnings: почистить `unused`/`dead_code`, навести порядок в импортах
- [ ] Jobs: таймаут/возврат задач, приоритеты, перерасчёт назначения
- [ ] Roads/Path: кэш стоимости тайлов и весов дорог; инвалидация при прокладке
- [ ] UI: визуализация маршрута жителей и линий доставки
 - [ ] Trees: лимит плотности, шанс саженца (рост реализован)
 - [x] Building: «Лесник» — базовая посадка в радиусе
 - [x] Resources: поля ресурсов и сейв/лоад
 - [x] Buildings: карьеры и обжиг (камень, глина→кирпич)
 - [x] Farming: пшеница→мука→хлеб
 - [x] Fishing: причал у воды
 - [x] UI: счётчики новых ресурсов на панели

Статус: останавливаем новые фичи и переходим к рефакторингу по списку выше. После — продолжаем «Дороги → A* → Склады». 

### Критерии готовности MVP

- 60 FPS в типовом окне; без швов на любом зуме
- Сохранение/загрузка воспроизводит мир и здания
- Лесоруб/дом/склад работают, ресурсы считаются корректно
- Нет утечек при перемещении камеры (чанки грузятся/выгружаются)





Вот набор «вкусных» идей с быстрыми победами и направлениями на подольше:

- Быстрые победы (можно сделать сегодня)
  - Анимация колобков: 2–4 кадра ходьбы + кадр «стоит» через `assets/citizen.png` (по времени и направлению движения). Точка входа: `render/map.rs::draw_citizens`.
  [x] Протяжка дорог мышью: зажатие ЛКМ тянет непрерывную линию дороги по A* или манхэттену. Точки: `ui_interaction.rs` + `world.set_road`.
  - Погода-оверлей: дождь/туман/снег как экранные слои с влиянием на производство. Точка: `main.rs::overlay_tint`, хук в симуляции `game.rs`.

- Визуал и пикс-арт
  - Ночные окна домов (мигающие «светлячки» у `House`) и факелы на дорогах ночью.
  - Простые «тени» от спрайтов (смещённые, полупрозрачные) для глубины.
  - Контур выделения выбранного здания/тайла (жирнее и контрастнее текущего).

- Жители и симуляция
  - Черты жителей: скорость, трудолюбие, «любит рыбу/хлеб» — влияет на счастье/производство.
  - Обучение профессиям: `Forester` получает бонус после N дней работы.
  - Переносчики с тачками: постройка «Cart» ускоряет `HaulWood` вдоль дорог.

- Экономика и логистика
  - Апгрейды зданий (уровни): +скорость, но +содержание.
  - Дефицит/переполнение складов — визуальные предупреждения и автоприоритеты доставки.
  - Простые графики трендов (золото/хлеб/население) на верхней панели за последний день/неделю.

- Мир и генерация
  - Биомы: луга/болота/скалы с разными модификаторами (у нас уже есть noise).
  - Реки как перлин-потоки; мосты как особая дорога.

- Ивенты
  - Праздник (бафф счастья/налога), засуха (минус пшеница), бандитский налёт на склады (мини-задача на «охрану» или уплату).

- UX/удобство
  - Выделение прямоугольником нескольких поленьев/дорог для массовых команд.
  - Горячие клавиши на политику еды и налоги; тултипы внизу поясняют эффект.
  - Мини-карта (низ-право): даунскейл тайлов, маркер камеры.

- Звук
  - Лёгкие SFX через `rodio`: шаги/дождь/постройка/урожай.

- Технически
  - Кэш сортированных структур и батчинг блитов для стабильного FPS на зуме.
  - Асинхронное планирование путей пакетами, чтобы пики не лагали.

Предлагаю начать с трёх быстрых:
1) Анимация колобков (покадрово) и подвязка к движению.
2) Протяжка дорог «потянул — проложилось».
3) Погода-оверлей с влиянием на производство.

С чего начнём?